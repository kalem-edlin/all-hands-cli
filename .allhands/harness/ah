#!/bin/bash
# all-hands: Agentic harness CLI for model-first software development
#
# This script provides the `ah` CLI entry point:
# - Auto-installs dependencies if missing
# - Loads environment from .env.ai
# - Routes to TypeScript CLI via tsx

set -e

# SCRIPT_DIR = .allhands/harness/
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# ALLHANDS_DIR = .allhands/
ALLHANDS_DIR="$(dirname "$SCRIPT_DIR")"
# PROJECT_ROOT = parent of .allhands/
PROJECT_ROOT="$(dirname "$ALLHANDS_DIR")"

# Load .env.ai from project root if exists
if [ -f "$PROJECT_ROOT/.env.ai" ]; then
    set -a
    . "$PROJECT_ROOT/.env.ai"
    set +a
fi

# Also check git root for .env.ai (may be different in worktrees)
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo "$PROJECT_ROOT")
if [ -f "$GIT_ROOT/.env.ai" ] && [ "$GIT_ROOT" != "$PROJECT_ROOT" ]; then
    set -a
    . "$GIT_ROOT/.env.ai"
    set +a
fi

# Auto-install if node_modules missing or package.json changed
if [ ! -d "$SCRIPT_DIR/node_modules" ] || ! cmp -s "$SCRIPT_DIR/package.json" "$SCRIPT_DIR/node_modules/.package.json.cache" 2>/dev/null; then
    echo "Installing/updating allhands dependencies..." >&2
    if ! npm install --prefix "$SCRIPT_DIR" --legacy-peer-deps 2>/dev/null; then
        echo "ERROR: npm install failed for allhands CLI" >&2
        exit 1
    fi
    cp "$SCRIPT_DIR/package.json" "$SCRIPT_DIR/node_modules/.package.json.cache" 2>/dev/null || true
fi

# Use tsx for direct TypeScript execution (no compile step needed)
exec "$SCRIPT_DIR/node_modules/.bin/tsx" "$SCRIPT_DIR/src/cli.ts" "$@"
